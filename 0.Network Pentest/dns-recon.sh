#!/bin/bash

if [ -z "$1" ]; then
  echo "Usage: $0 <domain>"
  exit 1
fi

DOMAIN=$1
OUT="recon_$DOMAIN"
mkdir -p $OUT

echo "[+] Starting Full DNS Recon for $DOMAIN"

### 1. Basic DNS records
echo "[+] Collecting DNS records..."
for r in A AAAA MX TXT NS SOA; do
  dig $DOMAIN $r > $OUT/$r.txt
done

### 2. Identify CDN IPs
echo "[+] Checking main IPs..."
dig +short $DOMAIN > $OUT/main_ips.txt

### 3. Subdomain discovery
echo "[+] Discovering subdomains..."
subfinder -d $DOMAIN -silent > $OUT/subs.txt
dnsrecon -d $DOMAIN -t brt >> $OUT/subs.txt
sort -u $OUT/subs.txt -o $OUT/subs.txt

### 4. Resolve subdomains
echo "[+] Resolving subdomains..."
while read sub; do
  ip=$(dig +short $sub | head -n 1)
  echo "$sub -> $ip" >> $OUT/resolved.txt
done < $OUT/subs.txt

### 5. Extract non-CDN IPs
echo "[+] Extracting possible origin IPs..."
grep -vE 'cloudflare|akamai|fastly|cloudfront' $OUT/resolved.txt > $OUT/origin_candidates.txt

### 6. SPF IP leaks
echo "[+] Checking SPF leaks..."
grep -Eo 'ip4:[0-9\.]+' $OUT/TXT.txt | cut -d: -f2 > $OUT/spf_ips.txt

### 7. SSL certificate leaks
echo "[+] Checking SSL certificate..."
echo | openssl s_client -connect $DOMAIN:443 2>/dev/null | openssl x509 -noout -text | grep -E "DNS:" >> $OUT/ssl_domains.txt

### 8. Validate origin candidates
echo "[+] Validating origin IPs..."
while read ip; do
  if curl -s --connect-timeout 3 http://$ip -H "Host: $DOMAIN" | grep -qi "$DOMAIN"; then
    echo "[FOUND] Origin IP: $ip" >> $OUT/confirmed_origins.txt
  fi
done < <(grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}' $OUT/origin_candidates.txt)

echo "[+] Recon completed: $OUT"
