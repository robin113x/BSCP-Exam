# Prototype Pollution

Prototype pollution is a JavaScript security bug where an attacker injects or changes properties on Object.prototype (the base object every normal object inherits from). Because most objects inherit from that prototype, changing it can silently change app behavior and lead to serious issues — often remote code execution, data tampering, or DOM XSS in browsers.



## How it works (simple steps)
- JavaScript objects inherit from Object.prototype.
	- Example: {} → inherits properties from Object.prototype.
- If an attacker can control a property name like __proto__ or constructor.prototype through user input (query strings, JSON, form fields), they can change that prototype.
- After pollution, any object that checks or uses the polluted property will see the attacker-controlled value.

Example payloads:
- Query-string style: /?__proto__[isAdmin]=true
- JSON-like (if an app naively merges user JSON into config): ``` {"__proto__":{"role":"admin"}} ```
```js
// before
Object.prototype.marker // undefined

// attacker injects ?__proto__[marker]=owned
Object.prototype.marker // "owned"
({}).marker             // "owned"  <-- every object now has marker

```

## Lab: Client-side prototype pollution via browser APIs

- Goal: Exploit client-side prototype pollution to trigger a DOM XSS (script.src) sink.

Manual approach

- Find pollution source: Inject into query string 
	- 	/?__proto__[foo]=bar and verify Object.prototype.foo appears in the browser console.
- Identify gadget: Inspect site scripts (Sources). 
	-	In searchLoggerConfigurable.js a transport_url is dynamically appended as a <script> but was made non-writable/unconfigurable with Object.defineProperty() without defining a value property — this creates a gadget that reads value.
- Exploit: Pollute prototype so the gadget picks up a value property: 
	-	/?__proto__[value]=data:,alert(1); — the page renders <script src="data:,alert(1);"> and alert(1) runs, solving the lab.

DOM Invader (Burp) approach

	- Load lab in Burp browser, enable DOM Invader with prototype-pollution option.
	- Reload; DOM Invader finds prototype-pollution vectors in the query string.
	- Click Scan for gadgets → DOM Invader locates the value gadget and the script.src sink.
	- Click Exploit → DOM Invader auto-generates the POC and triggers alert(1).
Key takeaway: Prototype pollution via __proto__ can inject properties that interact with existing DOM-creating gadgets (e.g., script insertion) to achieve DOM XSS.


---


## Lab:  DOM XSS via client-side prototype pollution

Goal: Use prototype pollution to control a script src and trigger DOM XSS.

Manual steps (quick):

-	Find pollution vector: Inject into query string:
	-	/?__proto__[foo]=bar → confirm Object.prototype.foo === "bar" in DevTools Console.
-	Identify gadget: Inspect site scripts (Sources). 
	-	searchLogger.js will append a <script> if config.transport_url exists — a potential gadget if that property is read later.
-	Exploit: Pollute the prototype with transport_url:
	-	/?__proto__[transport_url]=data:,alert(1);
	Check Elements — a <script src="data:,alert(1);"> appears and alert(1) runs. Lab solved.

Automated (Burp DOM Invader):

	- Load lab in Burp browser → enable DOM Invader + prototype-pollution.
	- Reload: it finds pollution vectors in the query string.
	- Click Scan for gadgets → it finds the transport_url gadget and the script.src sink.
	- Click Exploit → DOM Invader generates a POC and triggers alert(1).

Key takeaway: Polluting __proto__ can inject properties (like transport_url) that existing client-side code uses to create DOM elements (e.g., script tags), enabling DOM XSS.

---

## Lab: DOM XSS via an alternative prototype pollution vector

Goal: Exploit prototype pollution to inject malicious JavaScript into an eval() sink.

Manual solution

- Find prototype pollution source:

	- Test /?__proto__[foo]=bar → no effect.

	- Try /?__proto__.foo=bar → success (Object.prototype.foo now equals "bar").

- Identify gadget:

	- In searchLoggerAlternative.js, an eval() sink uses manager.sequence, which isn’t defined — potential gadget.

- Craft exploit:

	- Inject payload:
		- /?__proto__.sequence=alert(1)
		- → error occurs, showing alert(1)1 (extra “1” breaks syntax).

	- Fix syntax by appending a minus:
		- /?__proto__.sequence=alert(1)-
		- → valid JS, triggers alert(1) and solves the lab.

DOM Invader solution

	- Enable prototype pollution option and reload page.
	- DOM Invader detects pollution vector in query string.
	- Scan for gadgets → finds eval() sink via sequence property.
	- Generated PoC fails initially due to the trailing 1 in payload.
	- Manually append - to the payload in URL → alert(1) executes successfully.